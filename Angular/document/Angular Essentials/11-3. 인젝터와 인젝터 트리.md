# 3. 인젝터와 인젝터 트리

### 1. 인젝터(Injector)

Angular는 의존성 주입 요청에 의해 주입되어야 할 인스턴스가 있다면 이 인스턴스의 주입을 인젝터(Injector)에 요청한다. **인젝터는 컴포넌트와 모듈 레벨로 존재하며 의존성 주입 요청에 의해 프로바이더를 검색하고 인스턴스를 생성하여 의존성 인스턴스를 주입**한다.

의존성 요청이 있을 때마다 매번 의존성 인스턴스를 생성하는 것은 아니다. **인젝터는 인스턴스의 풀(pool)인 컨테이너를 관리하고 있다. 인젝터는 의존성 주입 요청을 받으면 프로바이더를 참조하여 요청된 인스턴스가 컨테이너에 존재하는지 검색한다. 이때 사용하는 것이 프로바이더의 provide 프로퍼티값인 토큰이다.** 기존에 생성된 인스턴스는 프로바이더의 토큰을 키로 컨테이너에 저장되어 있다. 인스턴스를 검색할 때는 토큰을 키로 인스턴스를 검색한다.

```tsx
providers: [{
	// 의존성 인스턴스의 타입(토큰, Token)
	provide: GreetingService,
	// 의존성 인스턴스를 생성할 클래스
	useClass: GreetingService
}]
```

만약 주입 요청을 받은 인스턴스가 컨테이너에 존재하면 새롭게 인스턴스를 생성하는 것이 아니라 컨테이너에 이미 존재하는 인스턴스를 주입하고, 요청된 인스턴스가 컨테이너에 존재하지 않으면 프로바이더의 useClass 프로퍼티를 참조하여 인스턴스를 생성하고 토큰을 키로 컨테이너에 추가한 후, 이 인스턴스를 constructor에 주입한다.

### 2. 인젝터 트리

컴포넌트는 트리 구조로 구성된다. 모든 컴포넌트는 각각 하나의 인젝터를 가지고 있기 때문에 컴포넌트의 트리 구조와 동일한 인젝터 트리(Injector tree)가 만들어 진다.

컴포넌트의 주입 요청이 있을 때 Angular는 해당 컴포넌트의 인젝터에게 의존성 주입을 요청한다. 해당 컴포넌트의 인젝터는 주입 대상의 프로바이더가 컴포넌트에 등록되어 있는지 검색한다.

예를 들어 아래와 같은 의존성 주입 요청이 있다고 해보자

```tsx
constructor(private user: UserService) {}
```

이 주입 요청에 대해 Angular는 다음과 같은 과정을 거쳐 의존성 주입을 완료한다.

1. 의존성 주입을 요청한 컴포넌트의 인젝터에 주입을 요청한다.
2. 주입을 요청받은 인젝터는 컴포넌트에서 UserService를 토큰으로 갖는(provide 프로퍼티값이 UserService인) 프로바이더를 찾는다.
3. 만약 프로바이더를 찾지 못하면 상위 컴포넌트의 인젝터로 의존성 주입 요청을 전달한다. 프로바이더를 찾을때까지 2, 3번 과정을 반복한다.
4. 만약 최상위 컴포넌트에서도 주입 대상의 프로바이더를 찾지 못하면 모듈에서 프로바이더를 검색한다. 어디에서도 프로바이더를 찾지 못하면 에러를 발생시킨다.
5. 프로바이더를 찾으면 인젝터는 해당 프로바이더를 사용하여 인스턴스를 주입한다.

Angular는 의존성 주입을 위해 인젝터 트리를 따라 올라가면서 의존성 인스턴스를 주입할 인젝터를 찾는다.

이때 의존성 인스턴스를 주입할 인젝터를 특정하는 기준은 프로바이더가 등록되어 있는 위치이다. 이는 인젝터 트리상 상위 인젝터는 하위 요소에 의존성 인스턴스를 제공할 수 있지만, 하위 인젝터가 상위 상위 요소에 의존성 인스턴스를 제공할 수는 없다는 것을 의미한다. 이것으로 알  수 있는 것을 정리하면 아래와 같다.

- 컴포넌트의 프로바이더에 등록되어 있는 서비스는 자신과 하위 컴포넌트에 주입할 수 있는 로컬 서비스이다.
- 루트 모듈의 프로바이더에 등록되어 있는 서비스는 애플리케이션 전역에 주입할 수 있는 전역 서비스이다. 루트 인젝터는 단일 인스턴스를 생성하고 인스턴스를 요청하는 모든 구성요소에게 동일한 싱글턴 인스턴스를 주입한다.